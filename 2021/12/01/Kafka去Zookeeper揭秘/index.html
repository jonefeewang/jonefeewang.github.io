<!DOCTYPE html><html lang="zh-CN"><head><meta name="google-site-verification" content="IqPxX6jMzoqSIvuvpvuP9PCF7niBjR9EBY0UfP9MHEU"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="王军飞的博客"><title>Kafka去Zookeeper揭秘 | 王军飞的随笔</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/latest/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/grids-responsive-min.min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/latest/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/latest/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/latest/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/latest/toastr.min.css"><meta name="generator" content="Hexo 7.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Kafka去Zookeeper揭秘</h1><a id="logo" href="/.">王军飞的随笔</a><p class="description">always be the best</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Kafka去Zookeeper揭秘</h1><div class="post-meta">2021-12-01<script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 4.7k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i><span class="post-count"> 16</span><span class="post-meta-item-text"> 分钟</span></span></span></div><a class="disqus-comment-count" href="/2021/12/01/Kafka%E5%8E%BBZookeeper%E6%8F%AD%E7%A7%98/#vcomment"><span class="valine-comment-count" data-xid="/2021/12/01/Kafka%E5%8E%BBZookeeper%E6%8F%AD%E7%A7%98/"></span><span> 条评论</span></a><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81Kafka%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%8E%BBZookeeper-%EF%BC%9F"><span class="toc-number">1.</span> <span class="toc-text">一、Kafka为什么要去Zookeeper ？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Zookeeper%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">2.</span> <span class="toc-text">Zookeeper的作用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Zookeeper%E7%9A%84%E5%8A%A3%E5%8A%BF%E5%92%8C%E4%B8%8D%E8%B6%B3"><span class="toc-number">3.</span> <span class="toc-text">使用Zookeeper的劣势和不足</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%83%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD%E9%80%9F%E5%BA%A6%E6%85%A2"><span class="toc-number">3.1.</span> <span class="toc-text">元数据加载速度慢</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7%E9%97%AE%E9%A2%98"><span class="toc-number">3.2.</span> <span class="toc-text">数据一致性问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E7%BB%B4%E6%8A%A4%E4%B8%80%E4%B8%AA%E7%BB%84%E4%BB%B6"><span class="toc-number">3.3.</span> <span class="toc-text">多维护一个组件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81Kafka%E5%8E%BBZookeeper%E6%9E%B6%E6%9E%84%E6%A6%82%E8%A7%88"><span class="toc-number">4.</span> <span class="toc-text">二、Kafka去Zookeeper架构概览</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-Kafka-Raft-%E7%AE%97%E6%B3%95"><span class="toc-number">5.</span> <span class="toc-text">三. Kafka Raft 算法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%87%E5%87%86Raft%E7%AE%97%E6%B3%95"><span class="toc-number">5.1.</span> <span class="toc-text">标准Raft算法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%BB%86%E8%89%B2%E5%88%86%E7%B1%BB"><span class="toc-number">5.1.1.</span> <span class="toc-text">⻆色分类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%BB%86%E8%89%B2%E8%BD%AC%E6%8D%A2"><span class="toc-number">5.1.2.</span> <span class="toc-text">⻆色转换</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B"><span class="toc-number">5.1.3.</span> <span class="toc-text">提交流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RPC%E8%AF%B7%E6%B1%82%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.1.4.</span> <span class="toc-text">RPC请求类型</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kafka-Raft%E7%AE%97%E6%B3%95"><span class="toc-number">5.2.</span> <span class="toc-text">Kafka Raft算法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%BB%86%E8%89%B2%E5%88%86%E7%B1%BB-1"><span class="toc-number">5.2.1.</span> <span class="toc-text">⻆色分类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%BB%86%E8%89%B2%E8%BD%AC%E6%8D%A2-1"><span class="toc-number">5.2.2.</span> <span class="toc-text">⻆色转换</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B-1"><span class="toc-number">5.2.3.</span> <span class="toc-text">提交流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RPC%E8%AF%B7%E6%B1%82%E7%B1%BB%E5%9E%8B-1"><span class="toc-number">5.2.4.</span> <span class="toc-text">RPC请求类型</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-Kafka-Raft%E6%80%9D%E8%80%83%E5%92%8C%E5%89%8D%E7%9E%BB"><span class="toc-number">6.</span> <span class="toc-text">三. Kafka Raft思考和前瞻</span></a></li></ol></div></div><div class="post-content"><h2 id="一、Kafka为什么要去Zookeeper-？"><a href="#一、Kafka为什么要去Zookeeper-？" class="headerlink" title="一、Kafka为什么要去Zookeeper ？"></a>一、Kafka为什么要去Zookeeper ？</h2><h2 id="Zookeeper的作用"><a href="#Zookeeper的作用" class="headerlink" title="Zookeeper的作用"></a>Zookeeper的作用</h2><p><strong>1 .依赖Zookeeper的一致性选举</strong></p>
<p>Kafka集群有多个节点组成，在管理集群级别的任务和数据时，必须有一个主来充当指挥者，Kafka内将这个主节点命名为Controller。在集群第一次启动或是Controller宕机时，集群内每个节点都会去争取当选Controller，在复杂网络环境下，要形成一个一致性的选举结果，目前这个任务是交由Zookeeper来完成的，各个节点在Zookeeper上抢占一个临时节点来当选，Kafka集群内部并未实现一致性协议。类似的主节点选举还包括每个分区的主副本(leader replica)。</p>
<p><img src="/2021/12/01/Kafka%E5%8E%BBZookeeper%E6%8F%AD%E7%A7%98/zk_status.svg"></p>
<p><strong>2 .依赖Zookeeper的存储和Listener监听回调</strong></p>
<p>Kafka的元数据，比如topic，partition，AR(assiged replica)，ISR，consumer等信息都存储在Zookeeper上，由Controller负责管理。另外，Controller还注册了很多监听器(Listener)，比如创建topic，扩容<br>parttion，ISR发生变化，broker节点上下线，partition重新分配，删除topic等，都是由admin工具或broker先在Zookeper上挂节点，触发Controller的监听器回调，由Controller执行具体的操作。</p>
<h2 id="使用Zookeeper的劣势和不足"><a href="#使用Zookeeper的劣势和不足" class="headerlink" title="使用Zookeeper的劣势和不足"></a>使用Zookeeper的劣势和不足</h2><h3 id="元数据加载速度慢"><a href="#元数据加载速度慢" class="headerlink" title="元数据加载速度慢"></a>元数据加载速度慢</h3><p>上边说过，Zookeeper存储了Kafka集群所有的元数据，集群的Controller每次启动时，都需要将所有的元数据从Zookeeper上全量拉取一次，试想当集群的broker节点、topic、consumer或partition数量线性增⻓<br>起来后，每次加载全量元数据的时间势必会很⻓，在此之间Controller是无法响应和工作的，这样势必会影响整个集群的可用性。此外zookeeper也不适宜存储大量的数据，读写qps的增加，以及leader和follower的<br>切换，很容易造成⻓时间的java gc停顿，影响Z ookeeper的可用性。所以元数据加载慢这个问题，直接影响了集群的大小，比如集群内节点数量不能很多，partition数量不能很大，比如超过 100 万个。</p>
<h3 id="数据一致性问题"><a href="#数据一致性问题" class="headerlink" title="数据一致性问题"></a>数据一致性问题</h3><p>上边说到，Controller会加载集群的所有元数据信息到内存内，加快读取速度，但是当集群的元数据需要变更时，Controller需要先将变更结果存储在Zookeeper上，再更新到本机内存，分成两步去操作和执行，这样做在实际运营过程中，很容易产生Zookeeper和内存数据不一致，甚至controller和其他节点的数据不一致，对集群可用性造成影响。另外，Controller在获取集群操作任务时，大多是由admin工具或其他broker在Zookeeper上挂节点，然后触发Controller的回调，回调执行完成后，再挂相应的watcher，整个过程中，很有可能漏掉一些watcher事件。所有这些问题产生的Zookeeper和内存数据的不一致，最终都必须重启<br>Controller节点来重新全量加载Zookeeper数据，来恢复整个集群的数据同一致性。</p>
<h3 id="多维护一个组件"><a href="#多维护一个组件" class="headerlink" title="多维护一个组件"></a>多维护一个组件</h3><p>使用Zookeeper还会带来另外一个问题，多维护一个组件，对于当今企业应用要求来说，这不仅意味着多一个不稳定因素，Zookeeper的不可用会导致Kafka的不可用，另外还需要一个team来维护zookeeper服务，增加⻛险和成本。</p>
<h2 id="二、Kafka去Zookeeper架构概览"><a href="#二、Kafka去Zookeeper架构概览" class="headerlink" title="二、Kafka去Zookeeper架构概览"></a>二、Kafka去Zookeeper架构概览</h2><p>使用Z ookeeper的K afka集群架构如下图所示，集群在部署的时候，除了部署Kafka集群外，还需要部署一个Zookeeper集群，Kafka集群每个节点都会有写入Zookeeper操作，除此之外，只有Controller才会读取Zookeeper上存储的元数据。</p>
<p><img src="/2021/12/01/Kafka%E5%8E%BBZookeeper%E6%8F%AD%E7%A7%98/now_arch.svg"></p>
<p>去除Zookeeper以后的集群部署如下：</p>
<p><img src="/2021/12/01/Kafka%E5%8E%BBZookeeper%E6%8F%AD%E7%A7%98/arch1.svg"></p>
<p>集群有 5 个节点，BrokerA和BrokerE是普通的节点，BrokerB、BrokerC、BrokerD是单纯的Controller节点。这里Controller是指一个⻆色，这三个Controller节点组成了一个一致性集群(Quorum)，三个节点会通过Raft算法选出一个Active的C ontroller担任整个集群真正的Controller，当Controller节点宕机或下线后，会重新选出一个新的Controller节点。</p>
<p>或是以下方式部署，每个Controller节点还可以同时起一个普通节点进程，在同一个Jvm内，但是在不同端口来接受服务请求。<br><img src="/2021/12/01/Kafka%E5%8E%BBZookeeper%E6%8F%AD%E7%A7%98/arch2.svg"></p>
<p>去除Zookeeper之后，需要在部署集群节点时，在配置文件内写清楚每个节点的⻆色(Role)，如果是Broker，就是普通节点，如果是Controller则是Controller节点，如果两个都有，则在同一个JVM内启动两个⻆色<br>的实例。同时还要写清楚集群Quroum的每个节点的IP，以及集群cluster ID等信息。</p>
<p><strong>集群数据存储方面，</strong> 集群的topic、consumer、partition等信息，从创建到变更都存储在Raft Log（相关的Raft背景知识可以先了解下）里，为了和原有的Kafka Log保持一致性和兼容，这里的RaftLog直接使用了Kafka原有Log的格式，并追加了一些特殊字段，除此之外可以理解为普通的Topic Log，但是只有一个partition，而且没有副本，没有partition leader。普通Broker节点会通过监听器，(从本机Raft层)实时接收最新的元数据变更信息，并应用到自己的metadata cache内，供本机使用。</p>
<p><strong>任务监听回调方面，</strong> 之前需要Controller监听Zookeeper节点所做的任务，比如Broker节点的上下线，是通过Broker节点和Active Controller节点之间的心跳来达成变更的，其他的比如创建topic、consumer、扩容partition等集群内任务，如果发到了普通节点，都会被转发给Active的Controller来执行，Active Controller将执行结果通过运行Raft算法来复制到Quorum的其他节点上，数据会在被各节点真正Committed（Raft Committed，这里需要了解一些Raft背景知识）之后，应用到本机的状态机内，形成metadata cache。</p>
<p>去除Zookeeper之后，集群的元数据在Quorum节点之内会以Raft Log方式来复制，因此当Controller宕机之后，新选出来的Active Controller本地就有全量数据，不需要再从其他节点拉取，这样就解决了上一部分说的“元数据加载慢”的问题，第二因为现在的元数据是以Raft Log的方式来存储和复制，也不存在“内存和Zookeeper”之间数据不一致的问题，由Raft来保障集群内所有节点上的元数据一致性。最后，去除了Zookeeper之后，因为数据就在Kafka内部，也不需要额外再维护另外一个组件。</p>
<h2 id="三-Kafka-Raft-算法"><a href="#三-Kafka-Raft-算法" class="headerlink" title="三. Kafka Raft 算法"></a>三. Kafka Raft 算法</h2><p>如果大家对Raft算法比较了解，我们拿Kafka Raft和传统的Raft算法做一个对比，就会比较容易理解。</p>
<h3 id="标准Raft算法"><a href="#标准Raft算法" class="headerlink" title="标准Raft算法"></a>标准Raft算法</h3><p>传统的Raft算法如下图</p>
<blockquote>
<p>*下图引用自Raft paper</p>
</blockquote>
<p><img src="/2021/12/01/Kafka%E5%8E%BBZookeeper%E6%8F%AD%E7%A7%98/raft.png"></p>
<h4 id="⻆色分类"><a href="#⻆色分类" class="headerlink" title="⻆色分类"></a>⻆色分类</h4><p> 为了更容易理解，我们把分布式一致性场景分为两种，一种是“正常场景”，就是服务正常运行期间，没有机器宕机，没有机器上下线，没有网络分区。另外一种是“异常场景”，就是前边说的反面，发生宕机，发生机器上下线，发生网络分区。</p>
<p>正常场景下，Raft集群内所有节点只有 2 中⻆色，Leader 和 Follower。</p>
<ul>
<li>leader: 集群内只有一个leader，负责接收客户端的请求，发送AE(AppendEntries)请求给follower，复制command或发送心跳。</li>
<li>Follower：被动接受leader发来的心跳请求或是复制过来的command.</li>
</ul>
<p>异常场景下，多了一种状态candidate</p>
<ul>
<li>candidate: 当某个节点决定参与leader选举时，会转换为这个状态。</li>
</ul>
<h4 id="⻆色转换"><a href="#⻆色转换" class="headerlink" title="⻆色转换"></a>⻆色转换</h4><ul>
<li>Follower: 一个节点进入Quorum集群后，就是Follower状态，当经过election timeout 时间后还未收到AE请求的话，那么就转换为Candidate状态。</li>
<li>Candidate: 当经过election timeout时间后，还未选举出Leader，重新进入Candidate状态，触发新一轮选举。</li>
<li>Leader：当Candidate收集到足够多的Votes之后，就转换为Leader状态。如果Leader在接收到AppendEntries响应之后，发现了新的Epoch，那么就转换为Candidate状态。</li>
</ul>
<h4 id="提交流程"><a href="#提交流程" class="headerlink" title="提交流程"></a>提交流程</h4><ol>
<li>客户端发送submit请求(包含的具体内容是command)给leader.</li>
<li>leader保存command到本地log里作为一个新的entry.</li>
<li>leader发送AppendEntries请求给集群内其他的server，</li>
<li>当Leader收集到集群内多数派server的正确响应后，将comand应用到本地状态机。</li>
<li>leader将上一步中状态机返回的结果返回给客户端</li>
</ol>
<h4 id="RPC请求类型"><a href="#RPC请求类型" class="headerlink" title="RPC请求类型"></a>RPC请求类型</h4><ol>
<li>AppendEntries 请求(简称AE请求): Leader发送给Follower的请求，不仅用来复制Raft Log，同时也用作心跳探活请求<ul>
<li>参数：term、leaderId、prevLogTerm、prevLogIndex、leaderCommit、entries</li>
<li>处理逻辑：Follower检查自己的Log是否符合p revLogTerm、prevLogIndex，如果不符合的话，说明发生日志分歧，返回给leader追加日志失败。如果符合的话，追加自己的Log里。检查Leader发送来的leaderCommit index和自己Log里的最大index，两者取最小值作为自己最新的commitIndex，前进的index所附带的entries是本次新的committed entry，状态机监听到以后会apply这些entry内附带的command。</li>
</ul>
</li>
<li>RequestVote 请求(简称Vote请求)</li>
</ol>
<ul>
<li>参数：candidateTerm、candidateID、LastLogIndex、LastLogTerm</li>
<li>处理逻辑：如果candidateTerm大于小于本机Term则直接拒绝，如果本机Term和candidateTerm相等，candidate的lastLogTerm大于本机logTerm，或者这两个term相等而且candidate的l astLogIndex大于本机logINdex，这返回成功，赞成这个选举，否则返回失败。</li>
</ul>
<h3 id="Kafka-Raft算法"><a href="#Kafka-Raft算法" class="headerlink" title="Kafka Raft算法"></a>Kafka Raft算法</h3><p>Kafka Raft里节点的状态转换如下图所示，但是注意下，这个是KIP里计划的，实际上Kafka 3.0版本代码实现上没有Observer这个⻆色，也没有Observer到Voter的转换，这几个功能还未真正实现。</p>
<p><strong>在Kafka Raft里，一些概念有不同的名词。比如Raft里的term，在kafka里称为epoch，Raft里的log index，在Kafka Raft里称之为offset</strong></p>
<blockquote>
<p>*下图引用自Kafka KIP-595</p>
</blockquote>
<p><img src="/2021/12/01/Kafka%E5%8E%BBZookeeper%E6%8F%AD%E7%A7%98/kraft.png"></p>
<h4 id="⻆色分类-1"><a href="#⻆色分类-1" class="headerlink" title="⻆色分类"></a>⻆色分类</h4><p>正常场景下，整个quorum里的⻆色包含以下几个：</p>
<ul>
<li>leader：接受客户端请求。注意这里的客户端不是指kafka生产消费消息的客户端，是指controller，controller在处理一些集群内管理事务时，会生成一些command，这些command 会提交给 leader，运行一次raft算法。</li>
<li>follower：主动从leader上拉取command，注意这点跟Raft是不一样的，在Raft里follower是一个被动⻆色，等待leader的AE请求。</li>
<li>observer：不参与抢主，也不参与投票，只从leader拉取command，类似zookeeper里的observer，作为一个状态机的只读节点。注意，虽然KIP-595里定义了这个⻆色，到目前为止，在 3 .0版本的实现里它实际上是一个状态为unattached的节点。</li>
</ul>
<p>异常场景下，会多几个⻆色：</p>
<ul>
<li>unattached：脱离状态的节点，一般是刚上线的新机器，之前没有参与过集群的任何事务，注意这个状态是代码实现里有的，没有在上图里标识出来。</li>
<li>candidate: 某个节点决定竞选leader后，会转换为这个状态。</li>
<li>voted：某个节点投了票之后会转换为这个状态</li>
<li>resigned：集群的leader准备卸任时，会转换为这个状态。注意这个状态是代码实现里有的，没有在上图里标识出来。<br>总结下，Kafka Raft里每个节点会有 7 种状态，比原生Raft多出了 4 个状态observer、unattached 、voted和resigned.</li>
</ul>
<h4 id="⻆色转换-1"><a href="#⻆色转换-1" class="headerlink" title="⻆色转换"></a>⻆色转换</h4><ol>
<li>Unattached: 这是节点启动的初始状态，任何一个节点启动来后，会先进入这个状态。 如果当前节点为Voter（也就是⻆色配置为Controller的节点），经过election timeout的时间后转换为Candidate。如果当前节点不是Voter，则发起拉取FR(FetchRequest)请求。</li>
<li>Candidate：经过election timeout之后，开始进行back off，给与其他Candidate发起Vote的机会，这里就是Raft paper中说到的Random时间发起Vote。如果在election timeout之内的话，会发起Vote请求。<br>如果在back off 时间结束之后的话，会再次转换为Candidate，继续发起新一轮Vote。 在收到多数派节点的Vote支持之后，当选为Leader，转换为Leader状态。</li>
<li>Voted：经过election timeout之后，转换为unattached状态，否则继续等待。</li>
<li>Leader：在收到resign请求后，转换为resigned状态。</li>
<li>Follower：经过election timeout 之后，转换为Candidate参与选举，否则发送FR请求，从Leader拉取最新的增量数据（依据上次拉取的Offset）。</li>
<li>Resigned：leader在收到 resign请求后，会转换为这个状态，然后跟其他节点发送EndQuorum请求，代表卸任这个leader任期。</li>
<li>Observer：Kafka 3.0版本中未实现这个⻆色。</li>
</ol>
<h4 id="提交流程-1"><a href="#提交流程-1" class="headerlink" title="提交流程"></a>提交流程</h4><ol>
<li>Active Controller执行了一些集群内的任务，如果需要写入metadata数据的话，会提交给Raft leader（也就是Active Controller）。</li>
<li>Follower发起Fetch请求，从Leader拉取自上次请求之后的新增数据，依据上次拉到的offset，leader返回新追加的数据。Leader查看Follower请求中的offset，比较多数派拉到的最小offset，前进<br>HighWaterMark，这里指的是标识已经被committed的数据。</li>
<li>Unattached节点，也就是当前 3.0版本中的普通节点Broker，也会发起FR操作，从Leader拉取自上次请求之后的新增数据，具体处理流程和Follower相同。</li>
<li>Follower和Unattached节点上，如果有增量的committed的数据，则会触发本机的metaDataListener的接收数据操作，这里的metaDataListener就是注册在Raft上的committed数据监听器。接收到的新数据会更新到本机的metadata cache中，供节点读取使用。</li>
</ol>
<h4 id="RPC请求类型-1"><a href="#RPC请求类型-1" class="headerlink" title="RPC请求类型"></a>RPC请求类型</h4><ol>
<li>Vote请求</li>
</ol>
<ul>
<li>参数：candidateEpoch、candidateId、lastOffsetEpoch、lastOffset</li>
<li>处理逻辑：处理逻辑和普通的Raft算法相同。</li>
</ul>
<ol start="2">
<li>BeginQuorum请求：leader发给q uorum里其他voter的请求。注意这个请求是标准R aft里没有的。其实这个请求的目的就是广播新当选的leader，因为在标准Raft里，心跳是由leader发出的，所以leader当选后发出心跳即可广播整个集群的新leaderID和leaderEpoch。但是kafka Raft在正常场景下都是依靠拉取(pull)来获得新的log的，没有从Leader发出的主动心跳请求，所以单加了这个。</li>
</ol>
<ul>
<li>参数：leaderId、leaderEpoch</li>
<li>处理逻辑：查看本机epoch是否和leader的e poch相同，不同的话更新epoch，转换为follower⻆色。</li>
</ul>
<ol start="3">
<li>EndQuorum请求：Kafka Raft新加的一个请求，作用是加速leader的优雅关闭。比如l eader在优雅关机的情况下，可以发出这个请求，主动通知其他Voter发起选举。如果么没有这个请求的话，其他Voter需要等待election timeout的而时间后才会发起新的选举，这无疑会延⻓集群无leader的时间。</li>
</ol>
<ul>
<li>参数：leaderId、leaderEpoch、preferredSuccessors</li>
<li>处理逻辑：接收到这个请求的voter会主动转换为candidate时间，但是会有一个不同的等待时间，这个等待时间是老的leader通过p referredSuccessors传给他的voter的。</li>
</ul>
<ol start="4">
<li>Fetch请求：这个是与标准Raft区别最大的地方，标准Raft是通过leader主动发起AE请求( push模式)给他节点，一方面复制log使用，另一方面作为心跳探活来使用。但是Kafka Raft是pull模式，所以log的拉取是依靠follower主动发起到leader的请求。这里需要介绍下Kafka Raft的snapShot，如下图所示，snapShot是Kafka节点里Kafka Raft的本机metadata数据的一个全量快照。Kafka会根据设定好的新增数据最大量来确定是否在log里某个offset新创建一个snapShot。<br><img src="/2021/12/01/Kafka%E5%8E%BBZookeeper%E6%8F%AD%E7%A7%98/snapshot.svg"><br>另外一个是在处理拉取请求时，leader需要比较Follower的日志状态。如下图所示，有些Follower的日志可能比leader少，比如(a)(b)。有些可能多，比如(c)(d)。有些情况有多又少，比如(e)(f)。leader需要根据不同的情况来处理，有些需要发送snapShot，有些需要告诉follower截取日志，有些正常的拉取，leader和follower根据请求和返回来前进自己的highWaterMark。</li>
</ol>
<blockquote>
<p>*下图引用自Raft paper</p>
</blockquote>
<p><img src="/2021/12/01/Kafka%E5%8E%BBZookeeper%E6%8F%AD%E7%A7%98/log.svg"></p>
<ul>
<li>参数：currentLeaderEpoch、fetchOffset、lastFetchEpoch、logStartOffset</li>
<li>处理逻辑：follower的fetchOffset如果不在leader的log范围之内，说明是新加入的follower或者是follower因为什么原因log差距太远了，这种情况下leader会返回响应，让follower再次发起一个拉取snapShot的请求。第二种情况是拉取leader检查出follower的lastFetchEpoch和fetchOffset与leader本机的log不匹配，发生了日志分歧，这时leader会返回一个调度日志的epoch和offset。最后一种情况是，follower拉取的offset范围是正常的，这时leader会返回上次拉取到当前的新增数据，如果没有的话，就等待一个时间。如果拉取到数据了，这时leader就可以检查多数派已经拉到的offset index，前进自己的highWaterMark。<br>Follower在接收到leader的响应后，如果是要拉取snapShot，就发送snapShot拉取请求。如果发生了日志分歧，就开始截取日志，然后再发起拉取请求。如果是正常的返回，则比较leader返回的highWaterMark和本机的highWaterMark，看自己是否需要更新。</li>
</ul>
<h2 id="三-Kafka-Raft思考和前瞻"><a href="#三-Kafka-Raft思考和前瞻" class="headerlink" title="三. Kafka Raft思考和前瞻"></a>三. Kafka Raft思考和前瞻</h2><p>以上就是Kafka去除Zookeeper的架构变更，和Kafka Raft的细节。虽然Kafka 2.8版本已经发布了KRaft模式作为Kafka 去除Z ookeeper预览，但是仍有一些重要的feature未实现。比如Quorum内节点替换，还有从非Raft模式到Raft模式的平滑滚动升级，这两项在实际的生产集群运营中都是必须的功能。</p>
<p>此外，Kafka Raft整个模块的实现，相对与整个Kafka系统来说相对独立，只有log层是和原有的Kafka log是共用，因此可以考虑抽离整个模块做成一个单独的lib库，替换一些服务依赖Zookeeper做一致性的功能，随服务一起发布。但这里有三个问题，第一，服务之前可能是无状态的，因为添加了Kafka Raft lib库之后变成了有状态服务，这样服务器的批量启停和替换必须得额外注意，不能全部关闭，因为Raft Quorum需要一定数量的节点才能运行。第二，因为Kafka Raft依赖磁盘来存储Raft log，而且每次追加Log时，必须是刷盘操作，因此对磁盘的性能和空间有一定的要求。第三，Zookeeper中实现的临时节点抢占操作、Listener回调等语义需要通过变通的方法来解决，因为原生Kafka Raft内没有这些api。</p>
<p>参考:</p>
<ol>
<li>KIP-595 、KIP-631</li>
<li>Raft paper</li>
</ol>
</div><div class="post-copyright"><script type="text/javascript" src="/js/copyright.js?v=1.0.0" successtext="复制成功！"></script><link rel="stylesheet" type="text/css" href="/css/copyright.css?v=1.0.0"><p><span>本文标题：</span>Kafka去Zookeeper揭秘</p><p><span>文章作者：</span>王军飞 jonefeewang@gmail.com</p><p><span>发布时间：</span>2021-12-01</p><p><span>最后更新：</span>2024-03-24</p><p><span>原始链接：</span><a href="/2021/12/01/Kafka去Zookeeper揭秘/">https://wangjunfei.com/2021/12/01/Kafka%E5%8E%BBZookeeper%E6%8F%AD%E7%A7%98/</a><span class="copy-path"><i class="fa fa-clipboard" data-clipboard-text="https://wangjunfei.com/2021/12/01/Kafka%E5%8E%BBZookeeper%E6%8F%AD%E7%A7%98/"></i></span></p><p><span>版权声明：</span>原创文章转载请注明出处</p></div><br><script type="text/javascript" src="/js/share.js?v=1.0.0" async></script><a class="article-share-link" data-url="https://wangjunfei.com/2021/12/01/Kafka%E5%8E%BBZookeeper%E6%8F%AD%E7%A7%98/" data-id="cm9gqqzdr0007b0820a3o6o66" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAN4AAADeCAAAAAB3DOFrAAACsElEQVR42u3awW7rMAwEwPz/T+cB71SgsL0kxSaH0SlIbUfjg6Qu+XrF4/1//Px89c3P73/fm//K7+/z55QHHh4eXmvqV+Pqh+//en/NuziqT8DDw8P7G15vcgn14efjZ1ZfKB4eHt438O4P0+UlO+DlLxEPDw/vO3lzfB525J/x8PDwPsVLgoD74/LZZ07iDDw8PLxtXq8A9tnP6/U9PDw8vFZVvTfyw3T1r+WZ4OHh4S3wJi1NVWQ1os0P8Q8zx8PDw1vg9f7tn7+sScBRbnvFw8PDO8rrxbX38WuveStvIyi8ejw8PLwFXrVpIFmme1OptrSO4l08PDy8MS+57RQpX+jzDexhY8DDw8M7yqsu4r1Adt4K0NxU8PDw8NZ4+aKfL+i9ZtZjoQMeHh7eAm9SysrvrTYQTLaWy9IXHh4e3lFeHo9WI9TqllANlx9mjoeHh7fMy7eHsw2peZNB9XCPh4eHt8FLpjiJD6opwaS0dvkEPDw8vKO8XvNoXs7vbQO9BqzLLQEPDw/vKG/SSJpsG9UnJFfmxTw8PDy8PV5voe/de+oAXSiD4eHh4R3llfuzxltCflCexL6v/B3j4eHhFXmnmqXmmHmbV3QNHh4e3piXl7Xyw/FGk0HvqI2Hh4e3wauWqarNAXlw0DuaF5B4eHh4C7xeqam3SVRh89eNh4eHd5aXHHB7C30e+05aZh+QeHh4eGu85NJqZDCPg6tluYfEBQ8PD2/MexdH7+h8qsw2arrCw8PDO8SbNFr1QttqwFHdfl69gYeHh1fk9UKBJM7oBRm9ohoeHh7e3/Oqm0G+5yRR72Tg4eHhfT9v3oQ6iY/Lh3g8PDy8j/LyxoIJO2lEKJTN8PDw8NZ483JUL8LIi23NgBgPDw9vgXe2AJYUqJLFfd4ai4eHh7fA+wff7LtgNoDGbAAAAABJRU5ErkJggg==">分享</a><div class="tags"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kafka-raft-kraft-zookeeper/" rel="tag">kafka raft kraft zookeeper</a></li></ul></div><div class="post-nav"><a class="pre" href="/2023/04/10/%E6%97%B6%E9%97%B4%E8%BD%AE%E7%AE%97%E6%B3%95%E5%88%86%E6%9E%90%E5%92%8C%E5%BA%94%E7%94%A8/">时间轮算法分析和应用</a><a class="next" href="/2021/09/15/PRFAQ%E7%BC%96%E5%86%99%E8%A7%84%E8%8C%83/">「转」PRFAQ编写规范</a></div><div class="nofancybox" id="vcomment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify = 'false' == 'true' ? true : false;
var verify = 'true' == 'true' ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'FNjCNRwQqC3sTPP04DfRFIk9-gzGzoHsz',
  appKey:'LzCq5t6a6RTkwXQVr8xLk0yj',
  serverURLs:'',
  placeholder:'请理性评论',
  avatar:'monsterid',
  guest_info:guest_info,
  pageSize:'10'
})
</script></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank"><input type="search" name="word" maxlength="20" placeholder="Search"/><input type="hidden" name="si" value="https://wangjunfei.com"/><input name="tn" type="hidden" value="bds"/><input name="cl" type="hidden" value="3"/><input name="ct" type="hidden" value="2097152"/><input name="s" type="hidden" value="on"/></form></div><div class="widget"><div class="author-info"><a class="info-avatar" href="/about/" title="关于"><img class="nofancybox" src="/img/avatar.png"/></a><p>Always be the best</p><a class="info-icon" href="mailto:jonefeewang@outlook.com" title="Email" target="_blank" style="margin-inline:5px"> <i class="fa fa-envelope-square" style="margin-inline:5px"></i></a><a class="info-icon" href="https://github.com/jonefeewang" title="Github" target="_blank" style="margin-inline:5px"> <i class="fa fa-github-square" style="margin-inline:5px"></i></a><a class="info-icon" href="/atom.xml" title="RSS" target="_blank" style="margin-inline:5px"> <i class="fa fa-rss-square" style="margin-inline:5px"></i></a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E6%8A%80%E6%9C%AF/">分布式技术</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%8A%A1%E8%99%9A-%E4%BA%A4%E6%B5%81%E6%B2%9F%E9%80%9A/">务虚-交流沟通</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%8A%A1%E8%99%9A-%E7%AE%A1%E7%90%86%E6%96%B9%E6%B3%95%E8%AE%BA/">务虚-管理方法论</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%A3%81%E7%9B%98%E8%AF%BB%E5%86%99%E4%BC%98%E5%8C%96/">磁盘读写优化</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Message-Queue/" style="font-size: 15px;">Message Queue</a> <a href="/tags/Rust/" style="font-size: 15px;">Rust</a> <a href="/tags/Kafka/" style="font-size: 15px;">Kafka</a> <a href="/tags/Pulsar/" style="font-size: 15px;">Pulsar</a> <a href="/tags/StoneMQ/" style="font-size: 15px;">StoneMQ</a> <a href="/tags/Apache-Pulsar/" style="font-size: 15px;">Apache Pulsar</a> <a href="/tags/Apache-Bookkeeper/" style="font-size: 15px;">Apache Bookkeeper</a> <a href="/tags/Apache-Kafka/" style="font-size: 15px;">Apache Kafka</a> <a href="/tags/Apache-pulsar-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97-kafka-RocketMQ/" style="font-size: 15px;">Apache pulsar 消息队列 kafka RocketMQ</a> <a href="/tags/kafka-raft-kraft-zookeeper/" style="font-size: 15px;">kafka raft kraft zookeeper</a> <a href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" style="font-size: 15px;">消息队列</a> <a href="/tags/rocketmq/" style="font-size: 15px;">rocketmq</a> <a href="/tags/kafka/" style="font-size: 15px;">kafka</a> <a href="/tags/pulsar/" style="font-size: 15px;">pulsar</a> <a href="/tags/%E5%8A%A1%E8%99%9A-%E7%AE%A1%E7%90%86%E6%96%B9%E6%B3%95%E8%AE%BA/" style="font-size: 15px;">务虚-管理方法论</a> <a href="/tags/%E5%8D%8E%E4%B8%BA/" style="font-size: 15px;">华为</a> <a href="/tags/%E7%AE%A1%E7%90%86%E6%96%B9%E6%B3%95%E8%AE%BA/" style="font-size: 15px;">管理方法论</a> <a href="/tags/%E7%AE%A1%E7%90%86/" style="font-size: 15px;">管理</a> <a href="/tags/%E5%8A%A1%E8%99%9A-%E9%A2%86%E5%AF%BC%E6%A2%AF%E9%98%9F/" style="font-size: 15px;">务虚-领导梯队</a> <a href="/tags/%E5%8A%A1%E8%99%9A/" style="font-size: 15px;">务虚</a> <a href="/tags/%E5%8D%8F%E4%BD%9C/" style="font-size: 15px;">协作</a> <a href="/tags/%E8%BD%AF%E7%B4%A0%E8%B4%A8/" style="font-size: 15px;">软素质</a> <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E6%8A%80%E6%9C%AF/" style="font-size: 15px;">分布式技术</a> <a href="/tags/zookeeper/" style="font-size: 15px;">zookeeper</a> <a href="/tags/consensus-algorithm/" style="font-size: 15px;">consensus algorithm</a> <a href="/tags/zab/" style="font-size: 15px;">zab</a> <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E5%8D%8F%E8%AE%AE/" style="font-size: 15px;">分布式协议</a> <a href="/tags/%E4%B8%80%E8%87%B4%E6%80%A7%E7%AE%97%E6%B3%95/" style="font-size: 15px;">一致性算法</a> <a href="/tags/%E6%96%B9%E6%B3%95%E8%AE%BA-%E8%BD%AF%E7%B4%A0%E8%B4%A8%E6%8F%90%E5%8D%87/" style="font-size: 15px;">方法论 软素质提升</a> <a href="/tags/kafka-netty-%E6%97%B6%E9%97%B4%E8%BD%AE/" style="font-size: 15px;">kafka netty 时间轮</a> <a href="/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/" style="font-size: 15px;">云原生</a> <a href="/tags/%E6%B5%81%E5%BC%8F%E8%AE%A1%E7%AE%97/" style="font-size: 15px;">流式计算</a> <a href="/tags/%E7%A3%81%E7%9B%98%E8%AF%BB%E5%86%99%E4%BC%98%E5%8C%96/" style="font-size: 15px;">磁盘读写优化</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2025/02/10/Announcing-Stonemq-A-high-performance-and-efficient-message-queue-developed-in-Rust/">Announcing Stonemq: A high-performance and efficient message queue developed in Rust</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/12/25/Apache-Pulsar%E7%9A%84%E5%AD%98%E5%82%A8%E6%A8%A1%E5%9E%8B/">Apache Pulsar的存储模型</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/09/15/Apache-pulsar%E5%AF%B9zookeeper%E7%9A%84%E4%BE%9D%E8%B5%96%E5%92%8C%E5%8E%BB%E9%99%A4%E5%88%86%E6%9E%90-%E4%BA%8C/">Apache pulsar对zookeeper的依赖和去除分析(二)</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/06/15/Apache-pulsar%E5%AF%B9zookeeper%E7%9A%84%E4%BE%9D%E8%B5%96%E5%92%8C%E5%8E%BB%E9%99%A4%E5%88%86%E6%9E%90-%E4%B8%80/">Apache pulsar对zookeeper的依赖和去除分析(一)</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/04/10/%E6%97%B6%E9%97%B4%E8%BD%AE%E7%AE%97%E6%B3%95%E5%88%86%E6%9E%90%E5%92%8C%E5%BA%94%E7%94%A8/">时间轮算法分析和应用</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/12/01/Kafka%E5%8E%BBZookeeper%E6%8F%AD%E7%A7%98/">Kafka去Zookeeper揭秘</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/09/15/PRFAQ%E7%BC%96%E5%86%99%E8%A7%84%E8%8C%83/">「转」PRFAQ编写规范</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/09/13/%E5%87%A0%E7%A7%8D%E5%B8%B8%E8%A7%81%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%96%B9%E6%B3%95%E8%AE%BA%E6%B1%87%E9%9B%86/">「转」几种常见的工作方法论汇集</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/08/14/%E8%BD%AF%E7%B4%A0%E8%B4%A8%E8%9E%BA%E6%97%8B%E4%B8%8A%E5%8D%87/">软素质螺旋上升</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/07/22/Mafka%E5%85%A8%E9%93%BE%E8%B7%AF%E5%BC%B9%E6%80%A7%E4%BC%B8%E7%BC%A9%E6%BC%94%E8%BF%9B%E7%AD%96%E7%95%A5/">Mafka全链路弹性伸缩演进策略</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2025 <a href="/." rel="nofollow">王军飞的随笔.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.js"></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0"></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="复制成功！"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>